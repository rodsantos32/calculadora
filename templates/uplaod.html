{% extends "base.html" %}

{% block title %}Upload{% endblock %}
{% block styles %}
{{ super() }} {# Garante que os estilos do base.html também sejam incluídos #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/upload.css') }}">
{% endblock %}

{% block content %}
<section class="relative w-screen mx-[calc(50%-50vw)] overflow-x-clip">

    <!-- Banner -->
    <section class="w-full pt-24">
        <div class="banner-upload-container">
            <div class="rounded-[50px] overflow-hidden bg-gradient-to-r from-red-700 via-red-600 to-neutral-900 shadow">
                <div class="flex  justify-center justify-between  gap-6  banner-upload-content">
                    <img src="/static/image/illustration-upload.svg" alt="Ilustração nota fiscal" class="">
                    <h2 class="uppercase">
                        transforme sua nota fiscal em informações valiosas
                    </h2>
                </div>
            </div>

            <form id="uploadForm" class="mt-4 flex  sm:flex-row sm:items-end sm:justify-between  px-6">
                <label for="xmlFile" class="cursor-pointer rounded-[20px] uppercase shadow hover:bg-neutral-700">
                    uplaod
                </label>
                <input id="xmlFile" type="file" accept=".xml" class="sr-only">
                <p>apenas arquivos pdf ou .xml</p>
            </form>
        </div>
    </section>

    <!-- Card branco -->
    <section class="w-full py-6">
        <div class="px-4 sm:px-6 lg:px-12 flex flex-col gap-4">
            <div class="relative rounded-[25px]  shadow p-8 min-h-[300px] h-auto upload-workspace-container">

                <img id="emptyState" src="../static/image/img-marcad'agua.svg" alt="">

                <!-- Itens da Nota -->
                <div id="itensContainer" class="hidden w-full upload-workspace-content flex">
                    <button id="btnFecharNota" class="hidden  upload-workspace-btn-close">
                        <img src="../static/image/icon-close-calc.svg" alt="">
                    </button>

                    <!-- Tabela -->
                    <div class="overflow-x-auto  ">
                        <table id="itensTable" class="min-w-full upload-workspace-table">
                            <thead>
                                <tr class="text-neutral-600 border-b uppercase">
                                    <th class="px-4 py-3 text-center">Código</th>
                                    <th class="px-4 py-3 ">Data Emissão</th>
                                    <th class="px-4 py-3 ">Descrição</th>
                                    <th class="px-4 py-3 ">Fornecedor</th>
                                    <th class="px-4 py-3">Unidade</th>
                                    <th class="px-4 py-3 ">Valor Unitário</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- preenchido via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Loader -->
                <div id="loading" class="hidden absolute inset-0 bg-white/70 grid place-items-center">
                    <div class="h-10 w-10 rounded-full border-2 border-red-600 border-t-transparent animate-spin"></div>
                </div>
            </div>

            <button id="btnEnviarItens" class="rounded-full  hover:bg-red-700  upload-btnEnviarItens">
                CADASTRAR NOTA FISCAL
            </button>
        </div>
    </section>
    
    <!-- Modal fechar nota -->
    <div id="nfCloseModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" aria-hidden="true" role="dialog" aria-modal="true">
        <div class=" rounded-[25px] p-6 w-full max-w-md upload-modal-closeNf">
            <h3 class="uppercase">Fechar Nota Fiscal?</h3>
            <p class="mb-4">Isso vai limpar a tabela e remover os itens salvos desta NF.</p>
            <div class="flex justify-center gap-3 upload-wrraper-closeNf  ">
                <button id="nfCloseCancel" class="rounded-[130px]  uppercase px-4 py-2 text-sm hover:bg-neutral-400">Cancelar</button>
                <button id="nfCloseConfirm" class="rounded-[130px]  uppercase px-4 py-2 text-sm text-white hover:bg-red-700">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal duplicata -->
    <div id="modalDuplicata" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-bold mb-2">Não foi possível envSSSiar</h3>
            <p class="mb-4">Foram encontrados itens já cadastrados com o mesmo <strong>valor_unitário</strong> e
                <strong>data_emissão</strong>:
            </p>
            <ul id="modalLista" class="list-disc pl-5 text-sm mb-4"></ul>
            <button id="modalFechar" class="mt-2 rounded bg-red-600 px-4 py-2 text-white hover:bg-red-700">
                Entendi
            </button>
        </div>
    </div>
    
    <!-- Produtos Criados -->
    <section id="produtosCriados" class="w-full py-6 hidden">
        <div class="px-4 sm:px-6 lg:px-12">
            <h2 class="text-lg font-semibold mb-4">Produtos Criados Recentemente</h2>
            <div id="produtosList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </section>



</section>
{% endblock %}

{% block scripts %}
<script>
    const emptyState = document.getElementById("emptyState");
    const itensContainer = document.getElementById("itensContainer");
    const itensTable = document.getElementById("itensTable");

    // função para verificar e alternar
    function atualizarEstadoCard() {
        const tbody = itensTable.querySelector("tbody");
        if (tbody && tbody.children.length > 0) {
            // se tem linhas na tabela → esconde logo e mostra tabela
            emptyState.classList.add("hidden");
            itensContainer.classList.remove("hidden");
        } else {
            // se não tem linhas → mostra logo e esconde tabela
            emptyState.classList.remove("hidden");
            itensContainer.classList.add("hidden");
        }
    }

    // chame a função logo no início
    atualizarEstadoCard();

    // se o seu código já adiciona linhas no tbody,
    // chame atualizarEstadoCard() logo depois de inserir as linhas
    window.atualizarEstadoCard = atualizarEstadoCard;
</script>
<script type="module" src="/static/js/pages/index.js"></script>

{% endblock %}